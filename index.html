
<?php
//Brenda
include 'SW_Route.php';
include 'shared/OP_CheckSession.php';
include 'shared/OP_CheckRecord.php';

$userId = $_SESSION['authenticated_user_id'];

//For Document & History View
// $relatedDocuments = ebs_GetRelatedDocs($jobId); // Put in OP_CheckRecord.php
$relatedJobs = ebs_GetOrganizationHistory($jobId);

//variable for display purpose
$bar1UserName = ebs_GetStaffName($userId);	//EBS_SharedFunctions

//Set Parameter
$showBar1_Tech_List = 'Yes';
$showBar2_General = 'Yes';
$showBar3_Tech_Detail = 'Yes';

//File output
// file_put_contents('JobDetails1.txt', print_r($relatedDocuments, true));	
// file_put_contents('JobDetails2.txt', print_r($relatedJobs, true));	

if(isset($_POST['startJob']))
{
	if($recordDetails['recordType'] == 'jobid')
	{
		$jobId = $recordDetails['recordId'];
		$retrivedDetails = ebs_RetrieveRecord(1, 'Jobs', $jobId);
		
		if(empty($actualJobEndDate))
		{
			if(empty($actualJobStartDate))
			{
				$retrivedDetails[$GLOBALS['cfid_ActualJobStartDate']] = $GLOBALS['TodaysDate'];
				$retrivedDetails[$GLOBALS['cfid_ActualJobStartTime']] = $GLOBALS['TodaysTime'];
			}
		}
	}
	else
	{
		$ticketId = $recordDetails['recordId'];
		$retrivedDetails = ebs_RetrieveRecord(1, 'HelpDesk', $ticketId);
		
		if(empty($actualJobEndDate))
		{
			if(empty($actualJobStartDate))
			{
				$retrivedDetails[$GLOBALS['cfid_ActualStartDate']] = $GLOBALS['TodaysDate'];
				$retrivedDetails[$GLOBALS['cfid_ActualStartTime']] = $GLOBALS['TodaysTime'];
			}
		}
	}

	ebs_UpdateRecord(1, $retrivedDetails);
	
	echo '<script type="text/javascript">alert("Job started at '.date('d-M-Y (g:i a)').'.")</script>';
}

?>
<!DOCTYPE html>
<html>
<title>TEST DEPLOY WAFII</title>
<meta charset="UTF-8">
<link href="favicon.ico" rel="icon" type="image/x-icon"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="text/javascript" src="<?php echo $GLOBALS['crmUrl']; ?>/jquery-3.5.1.min.js"></script>
<script>
 //var latitude;
  var result;
  
  function showPosition() 
  {
    // Store the element where the page displays the result
    result = document.getElementById("result");
	
    // If geolocation is available, try to get the visitor's position
    if(navigator.geolocation) 
    {
      navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
      result = "Getting the position information...";
    } 
    else 
    {
      alert("Sorry, your browser does not support HTML5 geolocation.");
    }
  };
    
  // Define callback function for successful attempt
  function successCallback(position) 
  {
	$.ajax({
	  url:"OP_JobStart.php?<?php echo $recordType; ?>=<?php echo $recordId; ?>",
	  method:"post",
	  data: position,
	  /*success: function(res){
		document.write(res);
	  }*/
	})

	alert("Job started at <?php echo date('d-M-Y (g:i a)'); ?>");
	
	location.reload();
  }

  function endPosition() 
  {
    // Store the element where the page displays the result
    result = document.getElementById("result");
    
    // If geolocation is available, try to get the visitor's position
    if(navigator.geolocation) 
    {
      navigator.geolocation.getCurrentPosition(successEndCallback, errorCallback);
      result = "Getting the position information...";
    } 
    else 
    {
      alert("Sorry, your browser does not support HTML5 geolocation.");
    }
  };
    
  // Define callback function for successful attempt
  function successEndCallback(position) 
  {
  	$.ajax({
      url:"OP_JobEnd.php?<?php echo $recordType; ?>=<?php echo $recordId; ?>",
      method:"post",
      data: position,
      /*success: function(res){
        document.write(res);
      }*/
    })
  }
  
  function errorCallback(error) 
  {
    if(error.code == 1) 
    {
      result.innerHTML = "You've decided not to share your position, but it's OK. We won't ask you again.";
	  alert("Please make sure you share your location before start a job.");
    } 
    else if(error.code == 2) 
    {
      result.innerHTML = "The network is down or the positioning service can't be reached.";
	  alert("The network is down or the positioning service can't be reached.");
    } 
    else if(error.code == 3) 
    {
      result.innerHTML = "The attempt timed out before it could get the location data.";
	  alert("The attempt timed out before it could get the location data.");
    } 
    else 
    {
      result.innerHTML = "Geolocation failed due to unknown error.";
	  alert("Geolocation failed due to unknown error.");
    }
  }

</script>
<head>
<title>TEST DEPLOY WAFI</title>
</head>
<body class="w3-white">
<link rel="stylesheet" href="css/w3styles.css">
<link rel="stylesheet" href="css/UI_EbsStyleSheet.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<?php
include 'UI_BarTop.php';
?>
  <h1>TEST DEPLOY WAFI HEAD 1</h1>
  <p>Testing testing testing</p>

  
  <div class="w3-row-padding w3-margin-top" id="myHeader"> </div>
  <div class="w3-row-padding" style="margin-top: 8px"><br>
  </div>
  <br><br>
  
  <!-- For ticket that related to job -->
  <?php echo $extraBreak; ?>

  <!-- Project Section -->
	<div id="Details" class="w3-container status w3-animate-opacity">
		<div style="padding-top: 30px">
		  <table style="width: 100%;">
		    <tr>
				<?php echo $setupLayoutButton; //For job baiting ?>
				<?php
				if(!empty($actualJobEndDate) || $jobStatus == 'Pending'  || $jobStatus == 'Closed' || $jobStatus == 'Work Performed')
				{
					?>
					<td style="float:right;">
					  <a href="UI_ClientJobDetails.php?user=<?php echo $userId; ?>&<?php echo $recordType; ?>=<?php echo $recordId;?>"><button type='submit' class="button hcustom9 w3-blue">Feedback</button></a>
					</td>
					<?php
				}
				
				if($jobStatus != 'Closed' && $jobStatus != 'Work Performed')
				{
					?>
					<td style="float:right;">
					  <a href="UI_TechnicianJobPostpone.php?user=<?php echo $userId; ?>&<?php echo $recordType; ?>=<?php echo $recordId; ?>"><button type='submit' class="button hcustom9 w3-yellow">Postpone</button></a>
					</td>
					<?php
				}
				?>
		    </tr>
		  </table>
		</div>
		
		<div class="section w3-orange w3-center">
		  <label>
			<b><p style="color:white;margin-top: 0px"><?php echo $recordLabel; ?> Status: <?php echo $jobStatus; ?></p></b>
		  </label>
		</div>
		
		<div class="section">
		  <label><b><?php echo $recordLabel; ?> Start</b></label><br>
		  <label><?php echo $jobStart; ?></label>  
		</div>
	<hr>
		<?php
		if(!empty($actualJobStartDate))
		{
			?>
			<div class="section">
				<label><b>Actual <?php echo $recordLabel; ?> Start</b></label><br>
				<label><?php echo $actualJobStart; ?></label>
			</div>
		<hr>
			<?php
			if(!empty($actualJobEndDate))
			{
				?>
				<div class="section">
					<label><b>Actual <?php echo $recordLabel; ?> End</b></label><br>
					<label><?php echo $actualJobEnd; ?></label>
				</div>
			<hr>
				<?php
			}
		}
		?>
		
		<div class="section">
		    <label><b><?php echo $contactName; ?></b></label><br>
			<label>Tel: <?php echo $contactMobile; ?></label>
		</div>
	<hr>
		<?php
		if($recordLabel == 'Job')
		{
			?>
			<div class="section">
				<label><b>Office Job Remarks</b></label><br>
				<label><?php echo $officeRemarks; ?></label>
			</div>
			<?php
		}
		else
		{
			?>
			<div class="section">
				<label><b>Ticket Description</b></label><br>
				<label><?php echo $officeRemarks; ?></label>
			</div>
			<?php
		}
		?>
	<hr>
		<div class="section">
		    <label><b>Premise Type</b></label><br>
			<label><?php echo $premiseType; ?></label><br>
		</div>
	<hr>
		<div class="section">
		    <label><b><?php echo $organizationName; ?></b></label><br>
			<label>Tel: <?php echo $organizationPhone; ?></label><br>
			<label><?php echo $organizationAddress; ?></label><br>
		</div>
		<div class="section">
			<a class="w3-button hcustom9 w3-dark-gray" href="https://maps.google.com/maps?f=q&source=s_q&hl=en&geocode=&q=<?php echo $mapUrl; ?>" target="_blank" data-role="button" data-ajax="false" >Navigate</a>
		</div>
	<hr>
		<?php 
		if($jobCategory == 'Baiting')
		{
			include 'UI_TechnicianBaitingForm.php';
		}
		else if($jobCategory == 'Fumigation')
		{
			include 'UI_TechnicianHygieneForm.php';
		}
		else
		{
			include 'UI_TechnicianGeneralForm.php';
		}
		
		?>
	</div>
	
	<?php 
	include 'UI_DocumentView.php';
	include 'UI_HistoryView.php'; 
	?>
 
<script type="text/javascript">
	function fileChange(e) 
	{
		for (var i = 0; i < e.target.files.length; i++)
		{ 
		  let self= this;
		  self.field= e.target.id;
		  let file = e.target.files[i];
		  console.log(self.field, file);	//self.field = instructionId
		  
		  if (file.type == "image/jpeg" || file.type == "image/png") 
		  {
			var reader = new FileReader();  
			reader.onload = function(readerEvent) 
			{
			  var image = new Image();
			  image.onload = function(imageEvent) 
			  {
				var max_size = 800;
				var w = image.width;
				var h = image.height;

				if (w > h) 
				{  
					if (w > max_size) 
					{ 
						h*=max_size/w; 
						w=max_size; 
					}
				}
				else     
				{  
					if (h > max_size) 
					{ 
						w*=max_size/h; 
						h=max_size; 
					} 
				}

				  var canvas = document.createElement('canvas');
				  canvas.width = w;
				  canvas.height = h;
				  canvas.getContext('2d').drawImage(image, 0, 0, w, h);
				  if (file.type == "image/jpeg") 
				  {
					var dataURL = canvas.toDataURL("image/jpeg", 1.0);
				  } 
				  else 
				  {
					var dataURL = canvas.toDataURL("image/png");    
				  }

				  //document.getElementsByClassName('inp_img')[i].value += dataURL + '|';
				  document.getElementsByName('inp_img[' + self.field + ']')[0].value += dataURL + '|';
				  
				  console.log("TEST "+ self.field +" VALUE:"+document.getElementsByName('inp_img[' + self.field + ']')[0].value);
				  
			  }
				
				// console.log("TEST VALUE");

				image.src = readerEvent.target.result;
			}
			
			reader.readAsDataURL(file);
			//console.log(reader.readAsDataURL(file));
		  } 
		  else 
		  {
			document.getElementsByName('inp_files[' + self.field + ']')[0].value += dataURL + '|';
			//document.getElementsByClassName('inp_files')[i].value = ''; 
			alert('Please only select images in JPG- or PNG-format.');   
			return false;
		  }
		}
	}
	var imagefiles = document.getElementsByClassName('inp_files');	//count instruction
	var imageimg = document.getElementsByClassName('inp_img');
	
	

	console.log(imagefiles);
	console.log(imageimg);
	
	for (var i=0; i<imagefiles.length; i++)
	{
		console.log("TEST VALUE");
		// console.log(imagefiles[i].value);
		imagefiles[i].addEventListener('change', fileChange, false);
	}

	//For show Bar3
	function openStatus(evt, statusName) 
	{
		var i;
		var x = document.getElementsByClassName("status");
		for (i = 0; i < x.length; i++) 
		{
			x[i].style.display = "none";
		}
		var activebtn = document.getElementsByClassName("testbtn");
		for (i = 0; i < x.length; i++) 
		{
			activebtn[i].className = activebtn[i].className.replace(" w3-light-gray", "");
		}
		document.getElementById(statusName).style.display = "block";
		evt.currentTarget.className += " w3-light-gray";
	}

	var mybtn = document.getElementsByClassName("testbtn")[0];
	mybtn.click();

	
	//For baiting form
	var coll = document.getElementsByClassName("collapsible");
	var i;

	for (i = 0; i < coll.length; i++) 
	{
		coll[i].addEventListener("click", function() 
		{
		  this.classList.toggle("active");
		  var content = this.nextElementSibling;
		  if (content.style.display === "block") 
		  {
			content.style.display = "none";
		  }
		  else 
		  {
			content.style.display = "block";
		  }
		});
	}
</script>
</body>
</html>